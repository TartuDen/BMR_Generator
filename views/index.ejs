<!-- index.ejs -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <!-- Your custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <title>Bootstrap Layout</title>

</head>

<body>

    <!-- Header -->
    <%- include("partials/header.ejs") %>

        <!-- Main content -->
        <div class="wrapper">
            <!-- Sidebar -->
            <%- include("partials/sidebar.ejs") %>

                <!-- Table content -->
                <%- include("partials/operation_table.ejs") %>
        </div>

        <!-- Footer -->
        <%- include("partials/footer.ejs") %>

            <!-- Bootstrap JS -->
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
                crossorigin="anonymous">
                </script>

            <script>
                var dataFromOperation = {};
                /**
                 * Save the selected item from a select element into the dataFromOperation object.
                 * 
                 * @param {HTMLSelectElement} selectElement - The select element from which to retrieve the selected value.
                 */
                function saveSelectedItem(selectElement) {
                    // Retrieve the selected value from the select element
                    var id = selectElement.id;
                    var value = selectElement.value;


                    // Add new elements into dataFromOperation
                    dataFromOperation[id] = value;
                    console.log(dataFromOperation);
                }
            </script>

            <script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>
            <script src="callFunc.js"></script>
            <script src="apiMocks.js"></script>
            <script src="helpers.js"></script>
            <script src="operationClasses.js"></script>

            <script>

                /**
                 * Asynchronously populates the equipment types dropdown menu.
                 * Retrieves equipment types data and dynamically creates options for the dropdown.
                 * 
                 * @async
                 * @function populateEquipmentTypes
                 * @memberof window
                 * @returns {void}
                 */
                async function populateEquipmentTypes() {
                    try {
                        let equipmentTypes = <%- JSON.stringify(equipmentTypes) %>;

                        // Check if equipmentTypes is an array or not

                        var selectElement = document.getElementById('equipmentType');
                        selectElement.innerHTML = '';
                        addDefaultOption(selectElement);
                        equipmentTypes.forEach(function (equipmentType) {
                            var option = document.createElement('option');
                            option.value = equipmentType.name;
                            option.textContent = equipmentType.name;
                            selectElement.appendChild(option);
                        });

                    } catch (error) {
                        console.error("Error populating equipment types:", error);
                        // Handle the error if needed
                    }
                }

                /**
                 * Event handler for when the window loads.
                 * Calls populateEquipmentTypes function to populate equipment types dropdown menu.
                 * 
                 * @async
                 * @function
                 * @memberof window
                 * @returns {void}
                 */
                window.onload = async function () {
                    await populateEquipmentTypes();
                };

                /**
                 * Asynchronously populates the activity types dropdown menu based on the selected equipment type.
                 * Retrieves activity types data and dynamically creates options for the dropdown.
                 * 
                 * @async
                 * @function populateActivityType
                 * @memberof window
                 * @param {string} equipmentType - The selected equipment type.
                 * @returns {void}
                 */
                async function populateActivityType(equipmentType) {
                    try {
                        // Call GetListEquipmentTypesMOCK to retrieve the list of equipment types
                        const response = await axios.post("http://localhost:8081/filter?equipmentType=" + dataFromOperation["equipmentType"]);
                        let activityTypes = JSON.parse(response.data);
                        var selectElement = document.getElementById('activityType');

                        // Clear previous options
                        selectElement.innerHTML = '';

                        // Add default option "--select--"
                        addDefaultOption(selectElement);

                        // Add equipment types as options
                        activityTypes.forEach(function (activity) {
                            var option = document.createElement('option');
                            option.value = activity.Content;
                            option.textContent = activity.OperationType;
                            selectElement.appendChild(option);
                        });

                        // Event listener for when an option is selected
                        selectElement.addEventListener('change', function () {
                            // Get the selected option
                            var selectedOption = selectElement.options[selectElement.selectedIndex];

                            let selectedActivityType = selectedOption.textContent;
                            let operationType = "operationType";

                            // Add operationType the dataFromOperation object
                            dataFromOperation[operationType] = selectedActivityType;
                        });

                    } catch (error) {
                        console.error("Error populating activity types:", error);
                        // Handle the error if needed
                    }
                }

                /**
                 * Populates the description of an activity within a specified div element.
                 * 
                 * @async
                 * @function populateDescription
                 * @memberof window
                 * @returns {void}
                 */
                async function populateDescription() {
                    const divElement = document.getElementById('description');

                    // Clear previous content
                    divElement.innerHTML = '';

                    if (dataFromOperation["activityType"]) {
                        const equipmentList = <%- JSON.stringify(equipmentListMemory) %>;
                        const materials = <%- JSON.stringify(materials) %>;
                        const project = <%- JSON.stringify(project) %>;
                        const tp = <%- JSON.stringify(TP) %>;
                        console.log(project);
                        // Call replaceTextWithSelect to populate the description
                        await replaceTextWithSelect(dataFromOperation["activityType"], equipmentList, materials, project, tp).then((description) => {
                            // Create a new <p> element
                            const newP = document.createElement("p");

                            // Set the html content of the <p> element with the populated description
                            newP.innerHTML = description;

                            // Append the <p> element to the div
                            divElement.appendChild(newP);
                        }).catch((error) => {
                            console.error('Error populating description:', error);
                        });
                    } else {
                        console.error('Activity type is not defined');
                        // If the activity type is not defined, handle it accordingly
                    }
                }

                /**
                 * Adds a default "--select--" option to a dropdown select element.
                 * 
                 * @function addDefaultOption
                 * @memberof window
                 * @param {HTMLElement} selectElement - The dropdown select element to which the default option will be added.
                 * @returns {void}
                 */
                function addDefaultOption(selectElement) {
                    // Create the default option element
                    var defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '--select--';

                    // Append the default option to the select element
                    selectElement.appendChild(defaultOption);
                }

                /**
                 * Parses dataFromOperation to create an Operation object.
                 * 
                 * @function parseDataToOperation
                 * @memberof window
                 * @returns {void}
                 */
                function parseDataToOperation() {
                    // Create an list of instances of Equipment class
                    let equipmentList = [];
                    for (let key in dataFromOperation) {
                        if (key.startsWith('equipment_')) {
                            let equipmentName = key.replace('equipment_', '');
                            let equipment = new Equipment(equipmentName, dataFromOperation[key]);
                            equipmentList.push(equipment);
                        }
                    }

                    // Create an instance of TypicalActivity class
                    let Activity = new TypicalActivity(
                        dataFromOperation['operationType'],
                        dataFromOperation['activityType'],
                        null,
                        null,
                        null,
                        null,
                        equipmentList
                    );

                    // Create an instance of Operation class
                    let operation = new Operation(1, dataFromOperation['equipmentType'], Activity);

                    // Do something with the operation object, such as sending it to the server or displaying it on the page
                    console.log(operation);
                }

                /**
                 * Purges dataFromOperation object except for the equipmentType property.
                 * 
                 * @function purgeDataFromOperation
                 * @memberof window
                 * @returns {void}
                 */
                function purgeDataFromOperation() {
                    // Clear the dataFromOperation object EXCEPT equipmentType
                    for (let key in dataFromOperation) {
                        if (key !== 'equipmentType') {
                            delete dataFromOperation[key];
                        }
                    }
                    console.log("Data from operation purged.");
                }

            </script>



</body>

</html>